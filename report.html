<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Report Incident ‚Äî CIER</title>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap");

      :root {
        --bg: #f4f7fa;
        --surface: rgba(255, 255, 255, 0.82);
        --nav-bg: rgba(255, 255, 255, 0.88);
        --text: #0f172a;
        --muted: #6b7280;
        --muted-strong: rgba(15, 23, 42, 0.58);
        --label-color: rgba(15, 23, 42, 0.68);
        --primary-solid: #1d4ed8;
        --danger: #ef4444;
        --success: #10b981;
        --radius: 14px;
        --card-border: rgba(15, 23, 42, 0.04);
        --shadow-nav: 0 16px 36px rgba(15, 23, 42, 0.18);
        --shadow-card: 0 24px 50px rgba(15, 23, 42, 0.12);
        --glass: rgba(15, 23, 42, 0.04);
        --base-font: 16px;
        --heading-xl: 22px;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        min-height: 100%;
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        font-size: var(--base-font);
        line-height: 1.6;
        letter-spacing: 0.015em;
        background: var(--bg);
        color: var(--text);
      }

      .container {
        max-width: 1100px;
        margin: 34px auto;
        padding: 28px 26px;
      }

      .top-nav {
        position: sticky;
        top: 0;
        z-index: 40;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-bottom: 26px;
        padding: 14px 22px;
        border-radius: 12px;
        background: var(--nav-bg);
        backdrop-filter: blur(14px);
        box-shadow: var(--shadow-nav);
      }

      .nav-left,
      .nav-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .nav-brand {
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        color: inherit;
      }

      .logo {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        background: var(--primary-solid);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 800;
        font-size: 18px;
      }

      .nav-title {
        display: flex;
        flex-direction: column;
        line-height: 1;
      }

      .nav-title .main {
        font-weight: 700;
        font-size: 16px;
      }

      .nav-title .sub {
        color: var(--muted);
        font-size: 13px;
        margin-top: 2px;
      }

      .nav-btn,
      .btn,
      .use-loc-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 18px;
        border-radius: 10px;
        border: 1px solid rgba(15, 23, 42, 0.06);
        background: transparent;
        color: var(--text);
        cursor: pointer;
        font-weight: 700;
        transition: transform 0.06s ease, box-shadow 0.12s ease;
      }

      .btn:hover,
      .nav-btn:hover,
      .use-loc-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(2, 6, 23, 0.1);
      }

      .btn.primary,
      .nav-btn.primary,
      .use-loc-btn {
        background: var(--primary-solid);
        color: #fff;
        border: none;
        box-shadow: 0 16px 40px rgba(29, 78, 216, 0.18);
      }

      .layout {
        display: grid;
        grid-template-columns: minmax(0, 1.8fr) minmax(300px, 0.7fr);
        gap: 20px;
        align-items: start;
      }

      .card {
        background: var(--surface);
        border: 1px solid var(--card-border);
        border-radius: var(--radius);
        padding: 20px 22px;
        box-shadow: var(--shadow-card);
        backdrop-filter: blur(18px);
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .row {
        display: flex;
        gap: 14px;
      }

      .col {
        flex: 1;
      }

      label {
        font-size: 15px;
        color: var(--label-color);
        font-weight: 600;
        margin-bottom: 8px;
      }

      input[type="text"],
      input[type="email"],
      textarea,
      select {
        width: 100%;
        padding: 14px 16px;
        font-size: 15px;
        border-radius: 12px;
        border: 1px solid rgba(15, 23, 42, 0.06);
        background: transparent;
        color: var(--text);
      }
      input[type="file"] {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px dashed rgba(15, 23, 42, 0.16);
        background: rgba(15, 23, 42, 0.02);
        color: var(--text);
        cursor: pointer;
      }
      input[type="file"]::file-selector-button {
        margin-right: 14px;
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid rgba(37, 99, 235, 0.35);
        background: rgba(37, 99, 235, 0.12);
        color: var(--primary-solid);
        font-weight: 600;
        cursor: pointer;
      }

      textarea {
        min-height: 140px;
        resize: vertical;
      }

      .small,
      .helper {
        font-size: 13.5px;
        color: var(--muted-strong);
      }

      .preview {
        max-width: 380px;
        margin-left: auto;
      }

      .preview h3 {
        font-size: 20px;
        font-weight: 700;
        margin: 0 0 6px;
      }

      .preview .badge {
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 13px;
      }

      .severity-low {
        background: rgba(59, 130, 246, 0.12);
        color: var(--primary-solid);
      }

      .severity-medium {
        background: rgba(249, 168, 37, 0.14);
        color: #b45309;
      }

      .severity-high {
        background: rgba(248, 113, 113, 0.14);
        color: #b91c1c;
      }

      .severity-critical {
        background: rgba(244, 63, 94, 0.16);
        color: #be123c;
      }

      .stat-grid {
        display: flex;
        gap: 16px;
        margin-top: 18px;
      }

      .stat {
        flex: 1;
        padding: 16px;
        border-radius: 10px;
        text-align: center;
        border: 1px solid rgba(15, 23, 42, 0.03);
        background: linear-gradient(180deg, rgba(2, 6, 23, 0.02), transparent);
      }

      .stat h3 {
        margin: 0;
        font-size: 20px;
        color: var(--text);
        font-weight: 800;
      }

      #desc-count {
        font-size: 13px;
        color: var(--muted);
        margin-top: 8px;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        box-shadow: 0 10px 36px rgba(37, 99, 235, 0.06);
        border-color: rgba(37, 99, 235, 0.4);
      }

      :focus:not(:focus-visible) {
        outline: none;
      }

      @media (max-width: 1040px) {
        .layout {
          grid-template-columns: 1fr;
          gap: 18px;
        }

        .preview {
          max-width: none;
          margin-left: 0;
        }
      }

      @media (max-width: 720px) {
        .top-nav {
          gap: 12px;
          padding: 12px 16px;
          margin-bottom: 20px;
        }

        .nav-title .sub {
          display: none;
        }

        .row {
          flex-direction: column;
        }
      }

      :root[data-theme="dark"] {
        --bg: linear-gradient(180deg, #0e141f 0%, #111827 100%);
        --surface: rgba(17, 24, 39, 0.85);
        --nav-bg: rgba(15, 23, 42, 0.78);
        --text: #f8fafc;
        --muted: rgba(203, 213, 225, 0.75);
        --muted-strong: rgba(203, 213, 225, 0.72);
        --label-color: rgba(226, 232, 240, 0.9);
        --primary-solid: #3b82f6;
        --card-border: rgba(148, 163, 184, 0.18);
        --shadow-nav: 0 18px 38px rgba(2, 6, 23, 0.55);
        --shadow-card: 0 32px 70px rgba(0, 0, 0, 0.45);
        --glass: rgba(148, 163, 184, 0.08);
      }

      :root[data-theme="dark"] input[type="text"],
      :root[data-theme="dark"] input[type="email"],
      :root[data-theme="dark"] textarea,
      :root[data-theme="dark"] select {
        background: rgba(15, 23, 42, 0.55);
        border-color: rgba(148, 163, 184, 0.24);
      }
      :root[data-theme="dark"] input[type="file"] {
        background: rgba(15, 23, 42, 0.55);
        border-color: rgba(148, 163, 184, 0.3);
        color: var(--text);
      }
      :root[data-theme="dark"] input[type="file"]::file-selector-button {
        border-color: rgba(96, 165, 250, 0.5);
        background: rgba(37, 99, 235, 0.24);
        color: #e0f2fe;
      }

      .hidden {
        display: none !important;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container">
      <nav class="top-nav" role="navigation" aria-label="Main">
        <div class="nav-left">
          <a href="./dashboard.html" class="nav-brand" title="CIER dashboard">
            <div class="logo">CI</div>
            <div class="nav-title">
              <div class="main">CIER</div>
              <div class="sub">Report Incident</div>
            </div>
          </a>
        </div>

        <div class="nav-right">
          <button
            type="button"
            id="theme-toggle"
            class="nav-btn"
            title="Toggle theme"
          >
            üåô Dark
          </button>
          <a href="./dashboard.html" class="nav-btn" title="Back to dashboard"
            >‚Üê Back</a
          >
          <button id="logout" class="nav-btn" title="Logout">Logout</button>
        </div>
      </nav>

      <main class="layout">
        <section class="card">
          <form id="report-form" novalidate enctype="multipart/form-data">
            <div>
              <label for="title">Title</label>
              <input
                id="title"
                name="title"
                type="text"
                placeholder="Brief descriptive title"
                required
              />
            </div>

            <div class="row">
              <div class="col">
                <label for="reporter">Reporter email</label>
                <input
                  id="reporter"
                  name="reporter"
                  type="email"
                  placeholder="you@example.com"
                />
              </div>
              <div style="width: 200px">
                <label for="incident-type">Incident Type</label>
                <div style="display: flex; flex-direction: column; gap: 8px">
                  <select id="incident-type" name="incident-type">
                    <option value="fire">Fire</option>
                    <option value="flood">Flood</option>
                    <option value="theft">Theft</option>
                    <option value="safety">Safety</option>
                    <option value="it_outage">IT outage</option>
                    <option value="medical">Medical</option>
                    <option value="environmental">Environmental</option>
                    <option value="other" selected>Other</option>
                    <option value="more">More...</option>
                  </select>
                  <input
                    id="incident-type-other"
                    placeholder="If Other or More, describe here..."
                    style="
                      display: none;
                      padding: 8px;
                      border-radius: 8px;
                      border: 1px solid rgba(255, 255, 255, 0.06);
                      background: transparent;
                      color: inherit;
                    "
                  />
                </div>
              </div>
              <input type="hidden" id="status" name="status" value="open" />
            </div>

            <div class="row">
              <div class="col">
                <label for="location">Location</label>
                <div style="display: flex; gap: 8px; align-items: center">
                  <input
                    id="location"
                    name="location"
                    type="text"
                    placeholder="Block A, Room 12"
                  />
                  <button
                    type="button"
                    id="use-location"
                    class="use-loc-btn"
                    title="Use my current location"
                    aria-label="Use my current location"
                  >
                    <svg
                      viewBox="0 0 24 24"
                      fill="none"
                      aria-hidden="true"
                      focusable="false"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M12 2v3"
                        stroke="currentColor"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                      <path
                        d="M12 19v3"
                        stroke="currentColor"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                      <path
                        d="M4.9 4.9l2.1 2.1"
                        stroke="currentColor"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                      <path
                        d="M17 17l2.1 2.1"
                        stroke="currentColor"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                      <path
                        d="M2 12h3"
                        stroke="currentColor"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                      <path
                        d="M19 12h3"
                        stroke="currentColor"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                      <path
                        d="M4.9 19.1l2.1-2.1"
                        stroke="currentColor"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                      <path
                        d="M17 7l2.1-2.1"
                        stroke="currentColor"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                      <circle
                        cx="12"
                        cy="12"
                        r="3"
                        stroke="currentColor"
                        stroke-width="1.5"
                        fill="rgba(255,255,255,0.05)"
                      />
                    </svg>
                    Use my location
                  </button>
                </div>
                <div
                  id="loc-status"
                  class="small"
                  style="margin-top: 6px; color: var(--muted)"
                ></div>
              </div>
              <div style="width: 160px">
                <label for="severity">Severity</label>
                <select id="severity" name="severity">
                  <option value="low">Low</option>
                  <option value="medium" selected>Medium</option>
                  <option value="high">High</option>
                  <option value="critical">Critical</option>
                </select>
              </div>
            </div>

            <div>
              <label for="description">
                Description <span class="small">(min 10 chars)</span>
              </label>
              <textarea
                id="description"
                name="description"
                placeholder="Describe what happened..."
                minlength="10"
              ></textarea>
              <div class="helper small" id="desc-count">0 characters</div>
            </div>
            <div>
              <label for="attachments">Upload evidence photos</label>
              <input
                id="attachments"
                name="attachments"
                type="file"
                accept="image/*"
                multiple
              />
              <div class="small">
                Attach up to 5 images (JPG or PNG, 5&nbsp;MB each). Files are
                stored securely with your report.
              </div>
            </div>

            <div
              class="actions"
              style="display: flex; gap: 12px; margin-top: 6px"
            >
              <button type="button" id="cancel" class="btn">Cancel</button>
              <button type="submit" class="btn primary">Submit Incident</button>
            </div>
          </form>

          <footer class="note small" style="margin-top: 12px">
            Reports are stored locally for this demo. Integrate with a backend
            to persist across devices.
          </footer>
        </section>

        <aside class="card preview" aria-live="polite">
          <div>
            <div
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
              "
            >
              <div>
                <h3 style="margin: 0 0 6px 0">Preview</h3>
                <div class="small">
                  See how your incident will appear on the dashboard
                </div>
              </div>
              <div style="width: 110px">
                <div class="small">Severity chart</div>
                <canvas id="severityChart" width="120" height="80"></canvas>
              </div>
            </div>

            <div
              style="
                margin-top: 12px;
                border-radius: 8px;
                padding: 12px;
                background: var(--glass);
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <strong id="pv-title">Untitled Incident</strong>
                <span id="pv-status" class="badge severity-low">Open</span>
              </div>

              <div class="small" style="margin-top: 8px">
                <div id="pv-location">Location: ‚Äî</div>
                <div id="pv-reporter">Reporter: ‚Äî</div>
                <div id="pv-time">Time: ‚Äî</div>
                <div id="pv-attachments">Attachments: none</div>
              </div>

              <p id="pv-desc" style="margin-top: 10px; color: var(--muted)">
                No description yet.
              </p>
            </div>
          </div>

          <div style="margin-top: 14px">
            <div class="small">Quick stats</div>
            <div class="stat-grid" style="margin-top: 8px">
              <div class="stat">
                <h3 id="stat-total">0</h3>
                <p>Total incidents</p>
              </div>
              <div class="stat">
                <h3 id="stat-open">0</h3>
                <p>Open</p>
              </div>
              <div class="stat">
                <h3 id="stat-closed">0</h3>
                <p>Closed</p>
              </div>
            </div>
          </div>
        </aside>
      </main>
    </div>

    <script>
      const THEME_KEY = "cier_theme";
      const themeToggleBtn = document.getElementById("theme-toggle");
      function applyTheme(theme) {
        const next = theme === "dark" ? "dark" : "light";
        document.documentElement.dataset.theme = next;
        localStorage.setItem(THEME_KEY, next);
        if (themeToggleBtn) {
          themeToggleBtn.textContent = next === "dark" ? "‚òÄÔ∏è Light" : "üåô Dark";
        }
      }
      const storedTheme = localStorage.getItem(THEME_KEY);
      const prefersDark = window.matchMedia(
        "(prefers-color-scheme: dark)"
      ).matches;
      applyTheme(storedTheme || (prefersDark ? "dark" : "light"));
      themeToggleBtn?.addEventListener("click", () => {
        applyTheme(
          document.documentElement.dataset.theme === "dark" ? "light" : "dark"
        );
      });

      const INCIDENTS_KEY = "cier_incidents";
      const CURRENT_USER_KEY = "cierCurrentUser";
      const LEGACY_USER_KEY = "currentUser";
      const NOMINATIM_ENDPOINT = "https://nominatim.openstreetmap.org/reverse";
      const API_INCIDENTS = "http://localhost:3800/incidents/";

      const incidentTypeSelect = document.getElementById("incident-type");
      const incidentTypeOther = document.getElementById("incident-type-other");

      function toggleIncidentOther() {
        const v = incidentTypeSelect.value;
        if (v === "other" || v === "more") {
          incidentTypeOther.style.display = "block";
          incidentTypeOther.focus();
        } else {
          incidentTypeOther.style.display = "none";
          incidentTypeOther.value = "";
        }
        updatePreview();
      }
      incidentTypeSelect.addEventListener("change", toggleIncidentOther);
      incidentTypeOther.addEventListener("input", updatePreview);

      function loadIncidents() {
        try {
          return JSON.parse(localStorage.getItem(INCIDENTS_KEY) || "[]");
        } catch {
          return [];
        }
      }
      function saveIncidents(list) {
        localStorage.setItem(INCIDENTS_KEY, JSON.stringify(list));
      }

      const locationInput = document.getElementById("location");
      const useLocationBtn = document.getElementById("use-location");
      let lastCoords = null;

      async function reverseGeocode(lat, lon) {
        const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`;
        const res = await fetch(url, {
          headers: { Accept: "application/json" },
        });
        if (!res.ok) return null;
        const data = await res.json();
        return data.display_name || null;
      }

      useLocationBtn?.addEventListener("click", () => {
        if (!navigator.geolocation) {
          alert("Geolocation is not supported by this browser.");
          return;
        }
        useLocationBtn.disabled = true;
        useLocationBtn.textContent = "Locating‚Ä¶";
        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            const { latitude, longitude } = pos.coords;
            lastCoords = { latitude, longitude };
            const address =
              (await reverseGeocode(latitude, longitude)) ||
              `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
            locationInput.value = address;
            useLocationBtn.textContent = "Use my location";
            useLocationBtn.disabled = false;
          },
          (err) => {
            console.error(err);
            alert("Could not fetch your location.");
            useLocationBtn.textContent = "Use my location";
            useLocationBtn.disabled = false;
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      });

      const form = document.getElementById("report-form");
      const cancelBtn = document.getElementById("cancel");
      const desc = document.getElementById("description");
      const descCount = document.getElementById("desc-count");
      const attachmentsInput = document.getElementById("attachments");
      const pvTitle = document.getElementById("pv-title");
      const pvStatus = document.getElementById("pv-status");
      const pvLocation = document.getElementById("pv-location");
      const pvReporter = document.getElementById("pv-reporter");
      const pvTime = document.getElementById("pv-time");
      const pvDesc = document.getElementById("pv-desc");
      const pvAttachments = document.getElementById("pv-attachments");
      const statTotal = document.getElementById("stat-total");
      const statOpen = document.getElementById("stat-open");
      const statClosed = document.getElementById("stat-closed");

      const currentUser =
        JSON.parse(localStorage.getItem(CURRENT_USER_KEY) || "null") ||
        JSON.parse(localStorage.getItem(LEGACY_USER_KEY) || "null");

      if (currentUser?.email) {
        const rep = document.getElementById("reporter");
        rep.value = currentUser.email;
        rep.readOnly = true;
      }

      let chart;
      function setupChart() {
        const ctx = document.getElementById("severityChart").getContext("2d");
        const data = countSeverity();
        chart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Low", "Medium", "High", "Critical"],
            datasets: [
              {
                data: [data.low, data.medium, data.high, data.critical],
                backgroundColor: ["#10b981", "#f59e0b", "#ef4444", "#db2777"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            cutout: "60%",
          },
        });
      }

      function updateChart() {
        if (!chart) return;
        const d = countSeverity();
        chart.data.datasets[0].data = [d.low, d.medium, d.high, d.critical];
        chart.update();
      }

      function countSeverity() {
        const list = loadIncidents();
        const counts = { low: 0, medium: 0, high: 0, critical: 0 };
        list.forEach((it) => {
          const s = (it.severity || "low").toLowerCase();
          if (counts[s] !== undefined) counts[s]++;
        });
        return counts;
      }

      function updatePreview() {
        const title =
          document.getElementById("title").value.trim() || "Untitled Incident";
        let type = incidentTypeSelect?.value?.trim() || "other";
        const otherText = incidentTypeOther?.value?.trim();
        if ((type === "other" || type === "more") && otherText) {
          type = otherText;
        } else if (type === "more" && !otherText) {
          type = "Other (more)";
        }
        const location =
          document.getElementById("location").value.trim() || "‚Äî";
        const reporter =
          document.getElementById("reporter").value.trim() ||
          currentUser?.email ||
          "‚Äî";
        const description = desc.value.trim() || "No description yet.";
        const severity = document.getElementById("severity").value || "low";
        const attachmentCount = attachmentsInput?.files.length || 0;

        pvTitle.textContent = title;
        pvStatus.textContent = type.replace(/_/g, " ");
        pvStatus.className = "badge " + severityClass(severity);
        pvLocation.textContent = "Location: " + location;
        pvReporter.textContent = "Reporter: " + reporter;
        pvTime.textContent = "Time: " + new Date().toLocaleString();
        pvDesc.textContent = description;
        pvAttachments.textContent =
          attachmentCount > 0
            ? `Attachments: ${attachmentCount} file${
                attachmentCount > 1 ? "s" : ""
              }`
            : "Attachments: none";

        descCount.textContent = desc.value.length + " characters";
      }

      function severityClass(s) {
        s = (s || "low").toLowerCase();
        if (s === "low") return "severity-low";
        if (s === "medium") return "severity-medium";
        if (s === "high") return "severity-high";
        if (s === "critical") return "severity-critical";
        return "severity-low";
      }

      ["title", "location", "reporter", "severity"].forEach((id) => {
        document.getElementById(id).addEventListener("input", updatePreview);
        document.getElementById(id).addEventListener("change", updatePreview);
      });
      desc.addEventListener("input", updatePreview);
      attachmentsInput?.addEventListener("change", updatePreview);

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const title = document.getElementById("title").value.trim();
        if (!title) {
          alert("Please enter a title");
          return;
        }
        const description = desc.value.trim();
        if (description.length < 10) {
          if (!confirm("Description looks short. Submit anyway?")) return;
        }

        const selectedType = (() => {
          const sel = incidentTypeSelect?.value || "other";
          const other = incidentTypeOther?.value?.trim();
          if ((sel === "other" || sel === "more") && other) return other;
          return sel;
        })();

        const prepared = {
          id: "i_" + Date.now(),
          title,
          description,
          location: document.getElementById("location").value.trim(),
          reporter: currentUser?.email || "anonymous",
          reportedBy: currentUser?.email || "anonymous",
          type: selectedType,
          status: document.getElementById("status").value || "open",
          severity: document.getElementById("severity").value || "low",
          createdAt: new Date().toISOString(),
          resolvedAt: null,
          attachmentsMeta: attachmentsInput
            ? Array.from(attachmentsInput.files).map((file) => ({
                name: file.name,
                size: file.size,
                type: file.type,
              }))
            : [],
          latitude: lastCoords?.latitude ?? null,
          longitude: lastCoords?.longitude ?? null,
          reportData: {
            title,
            description,
            type: selectedType,
            severity: document.getElementById("severity").value || "low",
          },
        };

        const localList = loadIncidents();
        localList.unshift(prepared);
        saveIncidents(localList);
        refreshStats();
        updateChart();

        try {
          const token = localStorage.getItem("token");
          const res = await fetch(API_INCIDENTS, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...(token ? { Authorization: "Bearer " + token } : {}),
            },
            body: JSON.stringify({
              title: prepared.title,
              description: prepared.description,
              location: prepared.location,
              reportedBy: prepared.reportedBy,
              type: prepared.type,
              status: prepared.status,
              severity: prepared.severity,
              attachments: prepared.attachmentsMeta,
              reportData: prepared.reportData,
              latitude: prepared.latitude,
              longitude: prepared.longitude,
            }),
          });

          const rawBody = await res.text();
          let parsedBody;
          try {
            parsedBody = rawBody ? JSON.parse(rawBody) : {};
          } catch {
            parsedBody = {};
          }

          if (res.ok) {
            const incident = parsedBody;
            const merged = {
              ...incident,
              title: incident.title || prepared.title,
              description:
                incident.description ||
                (incident.reportData && incident.reportData.description) ||
                prepared.description,
              type:
                incident.type ||
                (incident.reportData && incident.reportData.type) ||
                prepared.type,
              severity: incident.severity || prepared.severity,
              location: incident.location || prepared.location,
              reportedBy: incident.reportedBy || prepared.reportedBy,
              status: incident.status || "open",
              createdAt: incident.createdAt || new Date().toISOString(),
              latitude: incident.latitude ?? incident.lat ?? prepared.latitude,
              longitude:
                incident.longitude ?? incident.lng ?? prepared.longitude,
              reportData: incident.reportData || prepared.reportData,
            };

            const stored =
              JSON.parse(localStorage.getItem("cier_incidents") || "[]") || [];
            stored.unshift(merged);
            localStorage.setItem("cier_incidents", JSON.stringify(stored));
            window.location.href = "./dashboard.html";
          } else {
            console.error("Server error:", res.status, parsedBody);
            alert(
              `Saved locally but server returned error ${res.status}: ${
                parsedBody && parsedBody.error
                  ? parsedBody.error
                  : JSON.stringify(parsedBody)
              }`
            );
            window.location.href = "./dashboard.html";
            return;
          }
        } catch (err) {
          console.warn("Network error ‚Äî saved locally.", err);
          alert(
            "No network ‚Äî incident saved locally. It will appear in your incident log."
          );
          window.location.href = "./dashboard.html";
        }
      });

      cancelBtn.addEventListener("click", () => {
        window.location.href = "./dashboard.html";
      });

      function refreshStats() {
        const list = loadIncidents();
        statTotal.textContent = list.length;
        statOpen.textContent = list.filter((i) => i.status !== "closed").length;
        statClosed.textContent = list.filter(
          (i) => i.status === "closed"
        ).length;
      }

      document.getElementById("logout").addEventListener("click", () => {
        localStorage.removeItem("cierAuthToken");
        localStorage.removeItem("token");
        localStorage.removeItem("cierCurrentUser");
        window.location.href = "./login.html";
      });

      (function init() {
        toggleIncidentOther();
        updatePreview();
        refreshStats();
        setupChart();
        updateChart();
      })();
    </script>
  </body>
</html>
