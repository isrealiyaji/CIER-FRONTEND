<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CIER Dashboard</title>
    <style>
      :root {
        --bg: #0f172a;
        --card: #0b1220;
        --muted: #9aa4b2;
        --accent: #6366f1;
        --success: #10b981;
        --danger: #ef4444;
        --glass: rgba(255, 255, 255, 0.03);
      }
      body {
        margin: 0;
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI,
          Roboto, "Helvetica Neue", Arial;
        background: linear-gradient(180deg, #071129 0%, #071b2b 100%);
        color: #e6eef8;
      }
      .container {
        max-width: 1200px;
        margin: 28px auto;
        padding: 20px;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 20px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .logo {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, var(--accent), #48b5ff);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #fff;
      }
      .brand h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.2px;
      }
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .btn {
        background: var(--card);
        color: var(--muted);
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.04);
        cursor: pointer;
      }
      .btn.primary {
        background: linear-gradient(90deg, var(--accent), #48b5ff);
        color: white;
        border: none;
      }
      .layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 20px;
        align-items: start;
      }
      aside {
        background: var(--card);
        padding: 16px;
        border-radius: 12px;
        min-height: 300px;
        box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
      }
      main {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        padding: 18px;
        border-radius: 12px;
        min-height: 400px;
      }
      .stats {
        display: flex;
        gap: 12px;
        margin-bottom: 14px;
      }
      .card {
        flex: 1;
        background: var(--glass);
        padding: 14px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.03);
      }
      .card h3 {
        margin: 0 0 8px 0;
        font-weight: 600;
        color: #fff;
      }
      .card p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }
      .form-row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      input[type="text"],
      input[type="email"],
      textarea,
      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.06);
        color: #e6eef8;
        outline: none;
      }
      textarea {
        min-height: 90px;
        resize: vertical;
      }
      .actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .search {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 12px;
      }
      .search input {
        width: 260px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        color: #dbeeff;
      }
      th,
      td {
        text-align: left;
        padding: 10px 12px;
        font-size: 14px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      }
      th {
        color: var(--muted);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.6px;
      }
      tbody tr:hover {
        background: rgba(255, 255, 255, 0.02);
      }
      .status {
        padding: 6px 8px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 13px;
        display: inline-block;
      }
      .open {
        background: rgba(16, 185, 129, 0.12);
        color: var(--success);
      }
      .closed {
        background: rgba(239, 68, 68, 0.12);
        color: var(--danger);
      }
      .small {
        font-size: 12px;
        color: var(--muted);
      }
      @media (max-width: 880px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .search input {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="brand">
          <div class="logo">CI</div>
          <div>
            <h1>CIER — Incidents Dashboard</h1>
            <div class="small">Manage and track reported incidents</div>
          </div>
        </div>
        <div class="controls">
          <div id="current-user" class="small">Signed in</div>
          <button id="logout-button" class="btn">Logout</button>
        </div>
      </header>

      <div class="layout">
        <aside>
          <h3 style="margin-top: 0">Quick Actions</h3>
          <div style="margin: 12px 0">
            <button
              id="open-report-btn"
              class="btn primary"
              style="width: 100%"
            >
              Report Incident
            </button>
          </div>
          <div style="margin-top: 14px">
            <div class="small">Filters</div>
            <select id="filter-status" style="margin-top: 8px">
              <option value="">All statuses</option>
              <option value="open">Open</option>
              <option value="closed">Closed</option>
            </select>
            <div style="margin-top: 12px">
              <label class="small">Sort by</label>
              <select id="sort-by" style="margin-top: 6px">
                <option value="newest">Newest first</option>
                <option value="oldest">Oldest first</option>
              </select>
            </div>
          </div>
        </aside>

        <main>
          <div class="stats">
            <div class="card">
              <h3 id="total-incidents">0</h3>
              <p>Total incidents</p>
            </div>
            <div class="card">
              <h3 id="open-count">0</h3>
              <p>Open incidents</p>
            </div>
            <div class="card">
              <h3 id="closed-count">0</h3>
              <p>Closed incidents</p>
            </div>
          </div>

          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              gap: 12px;
              flex-wrap: wrap;
            "
          >
            <div class="search">
              <input
                id="search-input"
                placeholder="Search by title, description or reporter..."
              />
              <button id="clear-search" class="btn">Clear</button>
            </div>
            <div class="small">
              Showing <span id="shown-count">0</span> of
              <span id="total-count">0</span>
            </div>
          </div>

          <section style="margin-top: 14px">
            <table aria-label="Incidents table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Location</th>
                  <th>Reported by</th>
                  <th>Date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="incidents-table-body">
                <!-- rows populated by JS -->
              </tbody>
            </table>
          </section>

          <!-- Hidden / toggled report form -->
          <div id="report-panel" style="margin-top: 16px; display: none">
            <form id="report-incident-form">
              <div class="form-row">
                <div style="flex: 1">
                  <label for="incident-title">Title</label>
                  <input
                    id="incident-title"
                    required
                    type="text"
                    placeholder="Brief title of incident"
                  />
                </div>
                <div style="width: 200px">
                  <label for="incident-status">Status</label>
                  <select id="incident-status">
                    <option value="open">Open</option>
                    <option value="closed">Closed</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div style="flex: 1">
                  <label for="incident-location">Location</label>
                  <input
                    id="incident-location"
                    type="text"
                    placeholder="e.g. Block A, Room 12"
                  />
                </div>
                <div style="width: 220px">
                  <label for="incident-reporter">Your email</label>
                  <input
                    id="incident-reporter"
                    type="email"
                    placeholder="you@example.com"
                  />
                </div>
              </div>
              <div>
                <label for="incident-desc">Description</label>
                <textarea
                  id="incident-desc"
                  placeholder="Describe what happened"
                ></textarea>
              </div>
              <div class="actions">
                <button type="submit" class="btn primary">
                  Submit Incident
                </button>
                <button type="button" id="cancel-report" class="btn">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </main>
      </div>
    </div>

    <script>
      // Keep compatibility: respect existing localStorage keys if any
      const INCIDENTS_KEY = "cier_incidents";
      const USER_KEY = "currentUser";

      // UI elements
      const tbody = document.getElementById("incidents-table-body");
      const totalIncEl = document.getElementById("total-incidents");
      const openCountEl = document.getElementById("open-count");
      const closedCountEl = document.getElementById("closed-count");
      const shownCountEl = document.getElementById("shown-count");
      const totalCountEl = document.getElementById("total-count");
      const searchInput = document.getElementById("search-input");
      const filterStatus = document.getElementById("filter-status");
      const sortBy = document.getElementById("sort-by");
      const clearSearch = document.getElementById("clear-search");
      const reportPanel = document.getElementById("report-panel");
      const openReportBtn = document.getElementById("open-report-btn");
      const cancelReportBtn = document.getElementById("cancel-report");
      const reportForm = document.getElementById("report-incident-form");
      const logoutBtn = document.getElementById("logout-button");
      const currentUserEl = document.getElementById("current-user");

      // initialize current user display
      const currentUser = localStorage.getItem(USER_KEY)
        ? JSON.parse(localStorage.getItem(USER_KEY))
        : null;
      currentUserEl.textContent = currentUser?.email
        ? `Signed in as ${currentUser.email}`
        : "Not signed in";

      function loadIncidents() {
        try {
          return JSON.parse(localStorage.getItem(INCIDENTS_KEY) || "[]");
        } catch (e) {
          return [];
        }
      }

      function saveIncidents(list) {
        localStorage.setItem(INCIDENTS_KEY, JSON.stringify(list));
      }

      function renderIncidents() {
        const all = loadIncidents();
        const q = (searchInput.value || "").toLowerCase().trim();
        const statusFilter = filterStatus.value;
        const sorted = all.slice().sort((a, b) => {
          const ta = new Date(a.createdAt || a.date || 0).getTime();
          const tb = new Date(b.createdAt || b.date || 0).getTime();
          return sortBy.value === "oldest" ? ta - tb : tb - ta;
        });

        const filtered = sorted.filter((item) => {
          if (statusFilter && item.status !== statusFilter) return false;
          if (!q) return true;
          return (
            (item.title || "").toLowerCase().includes(q) ||
            (item.description || "").toLowerCase().includes(q) ||
            (item.reporter || "").toLowerCase().includes(q) ||
            (item.location || "").toLowerCase().includes(q)
          );
        });

        tbody.innerHTML = "";
        filtered.forEach((item) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td>${escapeHtml(item.title || "—")}</td>
          <td class="small">${escapeHtml(item.location || "—")}</td>
          <td class="small">${escapeHtml(item.reporter || "anonymous")}</td>
          <td class="small">${new Date(
            item.createdAt || item.date || Date.now()
          ).toLocaleString()}</td>
          <td><span class="status ${
            item.status === "closed" ? "closed" : "open"
          }">${item.status || "open"}</span></td>
        `;
          tbody.appendChild(tr);
        });

        totalIncEl.textContent = all.length;
        openCountEl.textContent = all.filter(
          (i) => i.status !== "closed"
        ).length;
        closedCountEl.textContent = all.filter(
          (i) => i.status === "closed"
        ).length;
        shownCountEl.textContent = filtered.length;
        totalCountEl.textContent = all.length;
      }

      // helpers
      function escapeHtml(str) {
        return String(str).replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[s])
        );
      }

      // events
      searchInput.addEventListener("input", () => renderIncidents());
      clearSearch.addEventListener("click", () => {
        searchInput.value = "";
        renderIncidents();
      });
      filterStatus.addEventListener("change", renderIncidents);
      sortBy.addEventListener("change", renderIncidents);

      openReportBtn.addEventListener("click", () => {
        reportPanel.style.display =
          reportPanel.style.display === "none" ? "block" : "block";
        reportPanel.scrollIntoView({ behavior: "smooth", block: "center" });
      });
      cancelReportBtn.addEventListener("click", () => {
        reportPanel.style.display = "none";
      });

      reportForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const title = document.getElementById("incident-title").value.trim();
        const description = document
          .getElementById("incident-desc")
          .value.trim();
        const location = document
          .getElementById("incident-location")
          .value.trim();
        const reporter =
          document.getElementById("incident-reporter").value.trim() ||
          currentUser?.email ||
          "anonymous";
        const status =
          document.getElementById("incident-status").value || "open";
        if (!title) {
          alert("Please enter a title");
          return;
        }

        const list = loadIncidents();
        list.unshift({
          id: "i_" + Date.now(),
          title,
          description,
          location,
          reporter,
          status,
          createdAt: new Date().toISOString(),
        });
        saveIncidents(list);
        reportForm.reset();
        reportPanel.style.display = "none";
        renderIncidents();
      });

      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("token");
        // Keep user object removal optional: uncomment to clear user
        // localStorage.removeItem(USER_KEY);
        window.location.href = "./login.html";
      });

      // initial render
      renderIncidents();

      // expose function name compatibility if other scripts call fetchIncidents
      window.fetchIncidents = renderIncidents;
    </script>
  </body>
</html>
