<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CIER Dashboard</title>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
      :root {
        --bg: #071129;
        --card: #0b1220;
        --muted: #9aa4b2;
        --accent: #6366f1;
        --success: #10b981;
        --danger: #ef4444;
        --glass: rgba(255, 255, 255, 0.03);
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
        background: linear-gradient(180deg, #071129, #071b2b);
        color: #e6eef8;
      }
      .container {
        max-width: 1200px;
        margin: 24px auto;
        padding: 16px;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 20px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .logo {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, var(--accent), #48b5ff);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #fff;
      }
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .btn {
        background: var(--card);
        color: var(--muted);
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.04);
        cursor: pointer;
      }
      .btn.primary {
        background: linear-gradient(90deg, var(--accent), #48b5ff);
        color: white;
        border: none;
      }

      .top-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 18px;
      }
      .card {
        background: var(--card);
        padding: 14px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.03);
      }
      .card h3 {
        margin: 0 0 6px 0;
        font-size: 20px;
        color: #fff;
      }
      .card p {
        margin: 0;
        color: var(--muted);
        font-size: 13px;
      }

      .layout {
        display: grid;
        grid-template-columns: 1fr 420px;
        gap: 16px;
        align-items: start;
      }
      .charts {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .chart-card {
        background: var(--card);
        padding: 12px;
        border-radius: 10px;
        min-height: 160px;
      }
      .filters {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }
      input[type="date"],
      select,
      input[type="text"] {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.06);
        color: #e6eef8;
        padding: 8px 10px;
        border-radius: 8px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        color: #dbeeff;
      }
      th,
      td {
        text-align: left;
        padding: 10px 12px;
        font-size: 14px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      }
      th {
        color: var(--muted);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.6px;
      }
      tbody tr:hover {
        background: rgba(255, 255, 255, 0.02);
        cursor: pointer;
      }

      .status {
        padding: 6px 8px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 13px;
        display: inline-block;
      }
      .open {
        background: rgba(16, 185, 129, 0.12);
        color: var(--success);
      }
      .closed {
        background: rgba(239, 68, 68, 0.12);
        color: var(--danger);
      }
      .small {
        font-size: 13px;
        color: var(--muted);
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(2, 6, 23, 0.6);
        z-index: 1200;
        padding: 20px;
      }
      .modal {
        width: 100%;
        max-width: 720px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 12px 40px rgba(2, 6, 23, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.04);
      }

      /* Hide summary cards / charts / preview box so only the incident list remains */
      .top-cards,
      .charts,
      .chart-card,
      .card.preview,
      aside {
        display: none !important;
      }

      /* Force main content to a single column so the incident log fills the page */
      .layout {
        grid-template-columns: 1fr !important;
        gap: 0;
      }

      /* Slight spacing tweak for the remaining incident log card */
      .card {
        margin-bottom: 12px;
      }

      @media (max-width: 1000px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .top-cards {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="brand">
          <div class="logo">CI</div>
          <div>
            <h1 style="margin: 0">CIER — Incidents Dashboard</h1>
            <div class="small">Live overview and incident manager</div>
          </div>
        </div>
        <div class="controls">
          <div id="current-user" class="small">Signed in</div>
          <!-- Replace the existing Report button or its JS handler with a direct link -->
          <!-- In the header/aside where the Report button exists, make it a link -->
          <div style="margin: 12px 0">
            <a
              id="open-report-btn"
              class="btn primary"
              href="./report.html"
              role="button"
              style="
                display: inline-block;
                text-decoration: none;
                text-align: center;
                width: 100%;
              "
              >Report Incident</a
            >
          </div>
          <button id="logout-button" class="btn">Logout</button>
        </div>
      </header>

      <section class="top-cards" aria-hidden="false">
        <div class="card">
          <h3 id="card-total">0</h3>
          <p>Total incidents</p>
        </div>
        <div class="card">
          <h3 id="card-open">0</h3>
          <p>Open incidents</p>
        </div>
        <div class="card">
          <h3 id="card-by-status">—</h3>
          <p>Incidents by status</p>
        </div>
        <div class="card">
          <h3 id="card-avg-time">—</h3>
          <p>Avg. time to resolution</p>
        </div>
      </section>

      <div class="layout">
        <div>
          <div class="filters">
            <input
              id="search-input"
              type="text"
              placeholder="Search title, reporter, location..."
            />
            <label class="small"
              >From <input id="date-from" type="date"
            /></label>
            <label class="small">To <input id="date-to" type="date" /></label>
            <select id="filter-status">
              <option value="">All statuses</option>
              <option value="open">Open</option>
              <option value="closed">Closed</option>
            </select>
            <select id="filter-severity">
              <option value="">All severities</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
            <button id="clear-filters" class="btn">Clear</button>
          </div>

          <div class="chart-card charts" aria-hidden="false">
            <div style="display: flex; gap: 12px; align-items: stretch">
              <div style="flex: 1; padding: 6px">
                <canvas
                  id="lineChart"
                  aria-label="Incidents over time"
                ></canvas>
              </div>
              <div
                style="
                  width: 260px;
                  display: flex;
                  flex-direction: column;
                  gap: 12px;
                "
              >
                <div style="flex: 1" class="card chart-card">
                  <canvas
                    id="pieChart"
                    aria-label="Incidents by severity"
                  ></canvas>
                </div>
                <div style="flex: 1" class="card chart-card">
                  <canvas
                    id="barChart"
                    aria-label="Top incident types"
                  ></canvas>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top: 12px" class="card">
            <h3 style="margin-top: 0">Incident Log</h3>
            <div class="small" style="margin-bottom: 8px">
              Click a row to toggle status. Click chart segments to filter.
            </div>
            <div style="overflow: auto; max-height: 360px">
              <table>
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Type</th>
                    <th>Location</th>
                    <th>Reporter</th>
                    <th>Date</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="incidents-table-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <aside class="card">
          <h3 style="margin-top: 0">Quick actions</h3>
          <div style="margin-top: 10px">
            <button id="open-modal" class="btn primary" style="width: 100%">
              Report Incident (popup)
            </button>
          </div>
          <div style="margin-top: 12px">
            <p class="small">Filters applied:</p>
            <div id="active-filters" class="small"></div>
          </div>
        </aside>
      </div>
    </div>

    <!-- Modal: Report Incident -->
    <div id="modal-overlay" class="modal-overlay" aria-hidden="true">
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="modal-title"
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
          "
        >
          <div>
            <h2 id="modal-title" style="margin: 0">Report an Incident</h2>
            <div class="small" style="margin-top: 4px">
              Provide details and submit — it will appear on your dashboard.
            </div>
          </div>
          <button id="close-modal" class="btn" title="Close">✕</button>
        </div>

        <form id="modal-report-form">
          <label for="modal-incident-title">Title</label>
          <input
            id="modal-incident-title"
            required
            type="text"
            placeholder="Brief title of incident"
          />

          <label for="modal-incident-type">Type</label>
          <input
            id="modal-incident-type"
            type="text"
            placeholder="e.g. Theft, Safety, IT outage"
          />

          <div style="display: flex; gap: 8px">
            <div style="flex: 1">
              <label for="modal-incident-location">Location</label>
              <input
                id="modal-incident-location"
                type="text"
                placeholder="e.g. Block A, Room 12"
              />
            </div>
            <div style="width: 150px">
              <label for="modal-incident-severity">Severity</label>
              <select id="modal-incident-severity">
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="low">Low</option>
              </select>
            </div>
          </div>

          <label for="modal-incident-reporter">Your email</label>
          <input
            id="modal-incident-reporter"
            type="email"
            placeholder="you@example.com"
          />

          <label for="modal-incident-desc">Description</label>
          <textarea
            id="modal-incident-desc"
            placeholder="Describe what happened"
          ></textarea>

          <div
            style="
              display: flex;
              gap: 8px;
              justify-content: flex-end;
              margin-top: 10px;
            "
          >
            <button type="button" id="modal-cancel" class="btn">Cancel</button>
            <button type="submit" class="btn primary">Submit</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Data keys
      const INCIDENTS_KEY = "cier_incidents";
      const USER_KEY = "currentUser";
      // Update this to your real backend endpoint
      const API_INCIDENTS = "http://localhost:3800/incidents/all";
      // POST/create endpoint (update if your API differs)
      const API_INCIDENTS_POST = "http://localhost:3800/incidents";

      // DOM
      const currentUserEl = document.getElementById("current-user");
      const tbody = document.getElementById("incidents-table-body");
      const totalIncEl = document.getElementById("card-total");
      const openCountEl = document.getElementById("card-open");
      const closedCountEl = document.getElementById("closed-count");
      const shownCountEl = document.getElementById("shown-count");
      const totalCountEl = document.getElementById("total-count");
      const searchInput = document.getElementById("search-input");
      const filterStatus = document.getElementById("filter-status");
      const filterSeverity = document.getElementById("filter-severity");
      const clearFilters = document.getElementById("clear-filters");
      const reportPanel = document.getElementById("report-panel");
      const openReportBtn = document.getElementById("open-report-btn");
      const cancelReportBtn = document.getElementById("cancel-report");
      const reportForm = document.getElementById("report-incident-form");
      const logoutBtn = document.getElementById("logout-button");

      // Fetch incidents from backend and update local storage so UI shows DB data
      async function fetchServerIncidents() {
        try {
          const token = localStorage.getItem("token");
          const res = await fetch(API_INCIDENTS, {
            method: "GET",
            headers: {
              Accept: "application/json",
              ...(token ? { Authorization: "Bearer " + token } : {}),
            },
          });
          const text = await res.text();
          let payload = null;
          try {
            payload = JSON.parse(text);
          } catch {
            payload = text;
          }
          if (!res.ok) {
            console.warn("Server returned", res.status, payload);
            return null;
          }
          // server may return array or { data: [...] }
          const list = Array.isArray(payload)
            ? payload
            : payload && payload.data && Array.isArray(payload.data)
            ? payload.data
            : null;
          if (!list) {
            console.warn("Unexpected server payload:", payload);
            return null;
          }
          // normalize minimal fields and save locally (keeps offline fallback)
          const normalized = list.map((it) => ({
            id: it.id || it._id || "i_" + Date.now() + Math.random(),
            title: it.title || it.name || "",
            description: it.description || it.details || "",
            location: it.location || "",
            reporter: it.reporter || it.email || "anonymous",
            status: it.status || "open",
            type: it.type || it.incidentType || "General",
            severity: it.severity || "medium",
            createdAt:
              it.createdAt || it.created_at || new Date().toISOString(),
            ...it,
          }));
          saveIncidents(normalized);
          return normalized;
        } catch (err) {
          console.warn("Could not fetch incidents from server:", err);
          return null;
        }
      }

      // initialize current user display
      const currentUser = localStorage.getItem(USER_KEY)
        ? JSON.parse(localStorage.getItem(USER_KEY))
        : null;
      currentUserEl.textContent = currentUser?.email
        ? `Signed in as ${currentUser.email}`
        : "Not signed in";

      function loadIncidents() {
        try {
          return JSON.parse(localStorage.getItem(INCIDENTS_KEY) || "[]");
        } catch (e) {
          return [];
        }
      }

      function saveIncidents(list) {
        localStorage.setItem(INCIDENTS_KEY, JSON.stringify(list));
      }

      function renderIncidents() {
        const all = loadIncidents();
        const q = (searchInput.value || "").toLowerCase().trim();
        const statusFilter = filterStatus.value;
        const severityFilter = filterSeverity.value;
        const sorted = all.slice().sort((a, b) => {
          const ta = new Date(a.createdAt || a.date || 0).getTime();
          const tb = new Date(b.createdAt || b.date || 0).getTime();
          return tb - ta;
        });

        const filtered = sorted.filter((item) => {
          if (statusFilter && item.status !== statusFilter) return false;
          if (severityFilter && item.severity !== severityFilter) return false;
          if (!q) return true;
          return (
            (item.title || "").toLowerCase().includes(q) ||
            (item.description || "").toLowerCase().includes(q) ||
            (item.reporter || "").toLowerCase().includes(q) ||
            (item.location || "").toLowerCase().includes(q)
          );
        });

        tbody.innerHTML = "";
        filtered.forEach((item) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td>${escapeHtml(item.title || "—")}</td>
        <td class="small">${escapeHtml(item.type || "—")}</td>
        <td class="small">${escapeHtml(item.location || "—")}</td>
        <td class="small">${escapeHtml(item.reporter || "anonymous")}</td>
        <td class="small">${new Date(
          item.createdAt || item.date || Date.now()
        ).toLocaleString()}</td>
        <td><span class="status ${
          item.status === "closed" ? "closed" : "open"
        }">${item.status || "open"}</span></td>
      `;
          tbody.appendChild(tr);
        });

        totalIncEl.textContent = all.length;
        openCountEl.textContent = all.filter(
          (i) => i.status !== "closed"
        ).length;
        closedCountEl.textContent = all.filter(
          (i) => i.status === "closed"
        ).length;
        shownCountEl.textContent = filtered.length;
        totalCountEl.textContent = all.length;
      }

      // Initial render + attempt to load from server and update UI
      (async function initIncidents() {
        renderIncidents(); // show local data immediately
        const serverList = await fetchServerIncidents();
        if (serverList) {
          // server data saved to localStorage by fetchServerIncidents -> re-render
          renderIncidents();
        } else {
          // server not available or returned error – UI remains using local data
          console.info(
            "Using local incidents (server not available or returned error)"
          );
        }
      })();

      // helpers
      function escapeHtml(str) {
        return String(str).replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[s])
        );
      }

      // events
      searchInput.addEventListener("input", () => renderIncidents());
      clearFilters.addEventListener("click", () => {
        searchInput.value = "";
        filterStatus.value = "";
        filterSeverity.value = "";
        renderIncidents();
      });
      filterStatus.addEventListener("change", renderIncidents);
      filterSeverity.addEventListener("change", renderIncidents);

      openReportBtn.addEventListener("click", () => {
        reportPanel.style.display =
          reportPanel.style.display === "none" ? "block" : "block";
        reportPanel.scrollIntoView({ behavior: "smooth", block: "center" });
      });
      cancelReportBtn.addEventListener("click", () => {
        reportPanel.style.display = "none";
      });

      reportForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const title = document.getElementById("incident-title").value.trim();
        const description = document
          .getElementById("incident-desc")
          .value.trim();
        const location = document
          .getElementById("incident-location")
          .value.trim();
        const reporter =
          document.getElementById("incident-reporter").value.trim() ||
          currentUser?.email ||
          "anonymous";
        const status =
          document.getElementById("incident-status").value || "open";
        const type =
          document.getElementById("incident-type").value.trim() || "General";
        const severity =
          document.getElementById("incident-severity").value || "medium";
        if (!title) {
          alert("Please enter a title");
          return;
        }

        // optimistic local save
        const tempId = "i_" + Date.now();
        const prepared = {
          id: tempId,
          title,
          description,
          location,
          reporter,
          status,
          type,
          severity,
          createdAt: new Date().toISOString(),
        };
        const list = loadIncidents();
        list.unshift(prepared);
        saveIncidents(list);
        renderIncidents();
        reportForm.reset();
        reportPanel.style.display = "none";

        // attempt to POST to backend; replace optimistic record on success
        try {
          const token = localStorage.getItem("token");
          const res = await fetch(API_INCIDENTS_POST, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...(token ? { Authorization: "Bearer " + token } : {}),
            },
            body: JSON.stringify({
              title,
              description,
              location,
              reporter,
              status,
              type,
              severity,
            }),
          });
          const text = await res.text();
          let body;
          try {
            body = JSON.parse(text);
          } catch {
            body = text;
          }
          if (res.ok) {
            const serverItem =
              body && typeof body === "object" ? body : prepared;
            if (!serverItem.createdAt)
              serverItem.createdAt = prepared.createdAt;
            // replace optimistic entry
            const updated = loadIncidents();
            const idx = updated.findIndex((i) => i.id === tempId);
            if (idx !== -1) updated.splice(idx, 1, serverItem);
            else updated.unshift(serverItem);
            saveIncidents(updated);
            renderIncidents();
            return;
          } else {
            console.error("Server error creating incident:", res.status, body);
            alert(`Saved locally but server returned error ${res.status}`);
            return;
          }
        } catch (err) {
          console.warn(
            "Network error when sending incident, saved locally.",
            err
          );
          alert(
            "No network — incident saved locally. It will appear in your incident log."
          );
          return;
        }
      });

      // submit from modal (save to same key and refresh table)
      modalForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const title = document
          .getElementById("modal-incident-title")
          .value.trim();
        const description = document
          .getElementById("modal-incident-desc")
          .value.trim();
        const location = document
          .getElementById("modal-incident-location")
          .value.trim();
        const reporter =
          document.getElementById("modal-incident-reporter").value.trim() ||
          JSON.parse(localStorage.getItem("currentUser") || "{}").email ||
          "anonymous";
        const status =
          document.getElementById("modal-incident-status").value || "open";
        const type =
          document.getElementById("modal-incident-type").value.trim() ||
          "General";
        const severity =
          document.getElementById("modal-incident-severity").value || "medium";
        if (!title) {
          alert("Please enter a title");
          return;
        }

        const tempId = "i_" + Date.now();
        const prepared = {
          id: tempId,
          title,
          description,
          location,
          reporter,
          status,
          type,
          severity,
          createdAt: new Date().toISOString(),
        };
        const list = loadIncidents();
        list.unshift(prepared);
        saveIncidents(list);
        renderIncidents();
        closeModal();

        try {
          const token = localStorage.getItem("token");
          const res = await fetch(API_INCIDENTS_POST, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...(token ? { Authorization: "Bearer " + token } : {}),
            },
            body: JSON.stringify({
              title,
              description,
              location,
              reporter,
              status,
              type,
              severity,
            }),
          });
          const text = await res.text();
          let body;
          try {
            body = JSON.parse(text);
          } catch {
            body = text;
          }
          if (res.ok) {
            const serverItem =
              body && typeof body === "object" ? body : prepared;
            if (!serverItem.createdAt)
              serverItem.createdAt = prepared.createdAt;
            const updated = loadIncidents();
            const idx = updated.findIndex((i) => i.id === tempId);
            if (idx !== -1) updated.splice(idx, 1, serverItem);
            else updated.unshift(serverItem);
            saveIncidents(updated);
            renderIncidents();
            return;
          } else {
            console.error("Server error creating incident:", res.status, body);
            alert(`Saved locally but server returned error ${res.status}`);
            return;
          }
        } catch (err) {
          console.warn(
            "Network error when sending incident, saved locally.",
            err
          );
          alert(
            "No network — incident saved locally. It will appear in your incident log."
          );
          return;
        }
      });

      // close modal on Escape
      document.addEventListener("keydown", (ev) => {
        if (ev.key === "Escape" && modalOverlay.style.display === "flex")
          closeModal();
      });

      // wire modal behaviour (new)
      const modalOverlay = document.getElementById("modal-overlay");
      const modalForm = document.getElementById("modal-report-form");
      const modalCancel = document.getElementById("modal-cancel");
      const closeModalBtn = document.getElementById("close-modal");

      function openModal() {
        modalOverlay.style.display = "flex";
        modalOverlay.setAttribute("aria-hidden", "false");
        // prefill reporter if signed in
        const cur = localStorage.getItem("currentUser")
          ? JSON.parse(localStorage.getItem("currentUser"))
          : null;
        const rep = document.getElementById("modal-incident-reporter");
        if (cur?.email && rep && !rep.value) rep.value = cur.email;
        // focus title
        document.getElementById("modal-incident-title").focus();
      }
      function closeModal() {
        modalOverlay.style.display = "none";
        modalOverlay.setAttribute("aria-hidden", "true");
        modalForm.reset();
      }

      // replace navigation to report page with modal open
      openReportBtn.removeEventListener?.("click", () => {}); // harmless if undefined
      openReportBtn.addEventListener("click", (e) => {
        e.preventDefault();
        openModal();
      });

      modalCancel.addEventListener("click", closeModal);
      closeModalBtn.addEventListener("click", closeModal);

      // initial render
      // renderIncidents(); <-- moved into initIncidents above
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn =
          document.getElementById("logout-button") ||
          document.getElementById("logout");
        if (!logoutBtn) {
          console.warn(
            "Logout button not found (looked for #logout-button and #logout)"
          );
          return;
        }

        logoutBtn.addEventListener("click", (e) => {
          e.preventDefault();
          try {
            localStorage.removeItem("token");
          } catch (err) {
            console.warn("Could not remove token", err);
          }
          // optionally clear current user:
          // try { localStorage.removeItem('currentUser'); } catch {}
          window.location.href = "./login.html";
        });
      });
    </script>
  </body>
</html>
